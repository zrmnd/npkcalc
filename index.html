<!DOCTYPE html>
<html lang="en-US">
<meta charset="utf-8">

<head>

</head>
<style>
    table,
    thead,
    tbody,
    tfoot,
    tr,
    td,
    th {
        border: 1px solid black;
        border-collapse: collapse;
        padding: 10px;
        text-align: left;
    }
    
    table {}
    
    tr:hover {
        background-color: #f5f5f5;
    }
</style>

<script>
    // writed by Egor Tryakshin, 2019 
    // tg: @zeromind 

    // K2O  -> K   = * 0.83015
    // P2O5 -> P   = * 0.43642
    // CaO  -> Ca  = * 0.71469
    // MgO  -> Mg  = * 0.603


    var elements = ["N_NO3", "N_NH4", "N", "P", "K", "Ca", "Mg", "S", "Fe", "B", "Zn", "Cu", "Mn", "Mo", "Cl"];
    var fertilizers = [{
            name: "Акварин 1 (7:11:30 4 3)",
            desc: "https://buyskie.ru/fertilizer/akvarin/",
            "N_NH4": 0,
            "N_NO3": 7,
            "P": 4.8,
            "K": 24.9045,
            "Mg": 2.412,
            "S": 3,
            "Fe": 0.054,
            "Zn": 0.014,
            "Cu": 0.01,
            "Mn": 0.042,
            "Mo": 0.004,
            "B": 0.02,
            "solublity25": 100
        }, {
            name: "Акварин 3 (3:11:35, хвойный)",
            desc: "N: 3%, P2O5: 11%, K2O: 35%, MgO: 4%, S: 9%, Fe (ДТПА) – 0,054; Zn (ЭДТА) – 0,014; Cu (ЭДТА) – 0,01; Mn (ЭДТА) – 0,042; Mo – 0,004; B – 0,02 ",
            "N_NH4": 0,
            "N_NO3": 3,
            "P": 4.8,
            "K": 29.06,
            "Mg": 2.412,
            "S": 9,
            "Fe": 0.054,
            "Zn": 0.014,
            "Cu": 0.01,
            "Mn": 0.042,
            "Mo": 0.004,
            "B": 0.02,
            "solublity25": 100
        }, {
            name: "Акварин 4 (6:12:33, 3:7)",
            desc: "https://buyskie.ru/fertilizer/akvarin/",
            "N_NH4": 1.5,
            "N_NO3": 4.5,
            "P": 5.23704,
            "K": 27.39495,
            "Mg": 1.809,
            "S": 7,
            "Fe": 0.054,
            "Zn": 0.014,
            "Cu": 0.01,
            "Mn": 0.042,
            "Mo": 0.004,
            "B": 0.02,
            "solublity25": 100
        },

        {
            name: "Акварин 6 (15:5:30 1.7 1.3)",
            desc: "https://buyskie.ru/fertilizer/akvarin/",
            "N_NH4": 3.7,
            "N_NO3": 11.3,
            "P": 2.1821,
            "K": 24.9045,
            "Mg": 1.0251,
            "S": 1.3,
            "Fe": 0.054,
            "Zn": 0.014,
            "Cu": 0.01,
            "Mn": 0.042,
            "Mo": 0.004,
            "B": 0.02,
            "solublity25": 100
        }, {
            name: "Акварин 7 (13:5:25 2 8)",
            desc: "https://buyskie.ru/fertilizer/akvarin/",
            "N_NH4": 6,
            "N_NO3": 7,
            "P": 2.1821,
            "K": 20.75375,
            "Mg": 1.206,
            "S": 8,
            "Fe": 0.054,
            "Zn": 0.014,
            "Cu": 0.01,
            "Mn": 0.042,
            "Mo": 0.004,
            "B": 0.02,
            "solublity25": 100
        }, {
            name: "Акварин 8 (19:6:20 1.5 1.4)",
            desc: "https://buyskie.ru/fertilizer/akvarin/",
            "N_NH4": 7.1,
            "N_NO3": 11.9,
            "P": 2.61852,
            "K": 16.603,
            "Mg": 0.9045,
            "S": 1.4,
            "Fe": 0.054,
            "Zn": 0.014,
            "Cu": 0.01,
            "Mn": 0.042,
            "Mo": 0.004,
            "B": 0.02,
            "solublity25": 100
        }, {
            name: "Акварин 9 (20:8:8 1.5 9)",
            desc: "https://buyskie.ru/fertilizer/akvarin/",
            "N_NH4": 13.2,
            "N_NO3": 6.8,
            "P": 3.49136,
            "K": 6.6412,
            "Mg": 0.9045,
            "S": 9,
            "Fe": 0.054,
            "Zn": 0.014,
            "Cu": 0.01,
            "Mn": 0.042,
            "Mo": 0.004,
            "B": 0.02,
            "solublity25": 100
        }, {
            name: "Акварин 10 (20:5:10, земляничный)",
            desc: "https://buyskie.ru/fertilizer/akvarin/",
            "N_NH4": 0,
            "N_NO3": 20,
            "P": 2.18,
            "K": 8.3,
            "Mg": 0.9,
            "S": 8.4,
            "Fe": 0.054,
            "Zn": 0.014,
            "Cu": 0.01,
            "Mn": 0.042,
            "Mo": 0.004,
            "B": 0.02,
            "solublity25": 100
        }, {
            name: "Акварин 11 (18:18:18)",
            desc: "https://buyskie.ru/fertilizer/akvarin/",
            "N_NH4": 8,
            "N_NO3": 10,
            "P": 7.85556,
            "K": 14.9427,
            "Fe": 0.054,
            "Zn": 0.014,
            "Cu": 0.01,
            "Mn": 0.042,
            "Mo": 0.004,
            "B": 0.02,
            "solublity25": 100
        }, {
            name: "Акварин 12 (12:12:35 1 0.7)",
            desc: "https://buyskie.ru/fertilizer/akvarin/",
            "N_NH4": 2,
            "N_NO3": 10,
            "P": 5.23704,
            "K": 29.05525,
            "Mg": 0.603,
            "S": 0.7,
            "Fe": 0.054,
            "Zn": 0.014,
            "Cu": 0.01,
            "Mn": 0.042,
            "Mo": 0.004,
            "B": 0.02,
            "solublity25": 100
        }, {
            name: "Акварин 13 (13:41:13)",
            desc: "https://buyskie.ru/fertilizer/akvarin/",
            "N_NH4": 8.6,
            "N_NO3": 4.4,
            "P": 17.89322,
            "K": 10.79195,
            "Fe": 0.054,
            "Zn": 0.014,
            "Cu": 0.01,
            "Mn": 0.042,
            "Mo": 0.004,
            "B": 0.02,
            "solublity25": 25
        }, {
            name: "Акварин 14 (17:6:18 1.5 7)",
            desc: "https://buyskie.ru/fertilizer/akvarin/",
            "N_NH4": 9,
            "N_NO3": 8,
            "P": 2.61852,
            "K": 14.9427,
            "Mg": 0.9045,
            "S": 7,
            "Fe": 0.054,
            "Zn": 0.014,
            "Cu": 0.01,
            "Mn": 0.042,
            "Mo": 0.004,
            "B": 0.02,
            "solublity25": 100
        }, {
            name: "Акварин 15 (3:11:38 3 9)",
            desc: "https://buyskie.ru/fertilizer/akvarin/",
            "N_NH4": 0,
            "N_NO3": 3,
            "P": 4.8,
            "K": 31.5457,
            "Mg": 1.809,
            "S": 9,
            "Fe": 0.054,
            "Zn": 0.014,
            "Cu": 0.01,
            "Mn": 0.042,
            "Mo": 0.004,
            "B": 0.02,
            "solublity25": 100
        }, {
            name: "Акварин 16 (6:12:36 2 4)",
            desc: "https://buyskie.ru/fertilizer/akvarin/",
            "N_NH4": 0,
            "N_NO3": 6,
            "P": 5.23704,
            "K": 29.8854,
            "Mg": 1.206,
            "S": 4,
            "Fe": 0.054,
            "Zn": 0.014,
            "Cu": 0.01,
            "Mn": 0.042,
            "Mo": 0.004,
            "B": 0.02,
            "solublity25": 100
        },

        {
            name: "KRISTALON 3-11-38 (Коричневый)",
            desc: "N: 3%, P2O5: 11%, K2O: 38%",
            "N_NH4": 0,
            "N_NO3": 3,
            "P": 4.8,
            "K": 31.55,
            "Mg": 2.412,
            "S": 11,
            "Fe": 0.07,
            "Zn": 0.025,
            "Cu": 0.01,
            "Mn": 0.04,
            "Mo": 0.004,
            "B": 0.025,
            "solublity25": 100
        }, {
            name: "KRISTALON 12-12-36 (Красный)",
            desc: "https://www.yara.ru/crop-nutrition/products/yaratera/yaratera-kristalon-12-12-36-red/",
            "N_NH4": 1.9,
            "N_NO3": 10.1,
            "P": 5.24,
            "K": 29.89,
            "Mg": 0.6,
            "S": 1,
            "Fe": 0.07,
            "Zn": 0.025,
            "Cu": 0.01,
            "Mn": 0.04,
            "Mo": 0.004,
            "B": 0.025,
            "solublity25": 100
        }, {
            name: "KRISTALON 7,5-12-36 (SCARLET)",
            desc: "https://www.agrovista.ru/magazin/product/kristalon-skarlet-7-5-12-36-4-5mg",
            "N_NH4": 0,
            "N_NO3": 7.5,
            "P": 5.24,
            "K": 29.89,
            "Mg": 2.8,
            "S": 4,
            "Fe": 0.15,
            "Zn": 0.027,
            "Cu": 0.04,
            "Mn": 0.06,
            "Mo": 0.004,
            "B": 0.027,
            "solublity25": 100
        }, {
            name: "KRISTALON 13-40-13 (желтый)",
            desc: "https://www.agrovista.ru/magazin/product/kristalon-zheltyy-13-40-13",
            "N_NH4": 8.6,
            "N_NO3": 4.4,
            "P": 17.4568,
            "K": 10.79195,
            "Fe": 0.07,
            "Zn": 0.025,
            "Cu": 0.04,
            "Mn": 0.04,
            "Mo": 0.004,
            "B": 0.025,
            "solublity25": 100
        }, {
            name: "KRISTALON 6-12-36 (ORANGE)",
            desc: "https://www.yara.ru/crop-nutrition/products/yaratera/yaratera-kristalon-6-12-36-orange/",
            "N_NH4": 1.5,
            "N_NO3": 4.5,
            "P": 5.23704,
            "K": 29.8854,
            "Mg": 1.809,
            "S": 8,
            "Fe": 0.07,
            "Zn": 0.025,
            "Cu": 0.01,
            "Mn": 0.04,
            "Mo": 0.004,
            "B": 0.025,
            "solublity25": 100
        }, {
            name: "KRISTALON  15-5-30+3MgO (белый)",
            desc: "https://www.agrovista.ru/magazin/product/kristalon-belyy-15-5-30-3mg",
            "N_NH4": 3.7,
            "N_NO3": 11.3,
            "P": 2.1821,
            "K": 24.9045,
            "Mg": 1.809,
            "S": 2,
            "Fe": 0.07,
            "Zn": 0.025,
            "Cu": 0.01,
            "Mn": 0.04,
            "Mo": 0.004,
            "B": 0.025,
            "solublity25": 100
        }, {
            name: "KRISTALON  19-6-20+3MgO (голубой)",
            desc: "https://www.yara.ru/crop-nutrition/products/yaratera/yaratera-kristalon-19-6-20-blue-label/",
            "N_NH4": 7.1,
            "N_NO3": 11.9,
            "P": 2.61852,
            "K": 16.603,
            "Mg": 1.809,
            "S": 3,
            "Fe": 0.07,
            "Zn": 0.025,
            "Cu": 0.01,
            "Mn": 0.04,
            "Mo": 0.004,
            "B": 0.025,
            "solublity25": 100
        }, {
            name: "KRISTALON  8-11-37+5MgO (томатный) ФЕРТИКА",
            desc: "https://fertika.com/product/dom-sad-i-ogorod/sad-i-ogorod/prod-24/",
            "N_NO3": 7.5,
            "P": 5.24,
            "K": 29.885,
            "Mg": 2.71,
            "S": 4,
            "Fe": 0.15,
            "Zn": 0.027,
            "Cu": 0.04,
            "Mn": 0.06,
            "Mo": 0.004,
            "B": 0.027,
        }, {
            name: "Кальций азотнокислый (5[Ca(NO3)2*2H2O]NH4NO3), буйский марка А",
            "Ca": 19.3,
            "N_NO3": 14.2,
            "N_NH4": 0.7
        }, {
            name: "Кальций азотнокислый безводный (Ca(NO3)2) Ч",
            "Ca": 24.18,
            "N_NO3": 16.89
        }, {
            name: "Кальций азотнокислый четырехводный (Ca(NO3)2*4H2O)), Ч",
            "Ca": 16.97,
            "N_NO3": 11.86
        }, {
            name: "Кальций азотнокислый (5[Ca(NO3)2*2H2O]NH4NO3), Yara CALCINIT",
            "Ca": 19,
            "N_NO3": 14.4,
            "N_NH4": 1.1
        }, {
            name: "Кальций азотнокислый (Solar)",
            desc: "https://solar.uralchem.com/ru/catalog/nitrat_kaltsiya_kontsentrirovannyy/",
            "Ca": 23.585,
            "N_NO3": 16.7,
            "N_NH4": 0.3
        }, {
            name: "Кальций хлористый безводный (CaCl2), Ч",
            desc: "https://pcgroup.ru/products/hloristyj-kaltsij-granulirovannyj-bezvodnyj/",
            "Ca": 36.1115,
            "Cl": 63.8885,
        }, {
            name: "Кальций хлористый двухводный (CaCl2*2H2O), Ч",
            "Ca": 27.26,
            "Cl": 48.23,
        }, {
            name: "Калий азотнокислый (KNO3), Ч",
            "K": 38.672,
            "N_NO3": 13.854,
            "solublity25": 36
        }, {
            name: "Калий азотнокислый (KNO3), буйский",
            desc: "https://bhz.ru/catalog/standart-min/nitrat-kaliya-selitra-kalievaya/",
            "K": 37.963,
            "N_NO3": 13.6,
            "solublity25": 36
        }, {
            name: "Калий фосфорнокислый 1-замещенный (монофосфат, KH2PO4), Ч",
            "K": 28.731,
            "P": 22.761
        }, {
            name: "Калий фосфорнокислый 1-замещенный (монофосфат, KH2PO4), буйский 0-50-33",
            "K": 27.545,
            "P": 21.821
        },

        {
            name: "Калиий сернокислый (Solupotasse, K2SO4)",
            "K": 43.896,
            "S": 18
        }, {
            name: "Магний сернокислый семиводный (MgSO4*7H2O), Ч",
            "Mg": 9.861,
            "S": 13.01,
            "solublity25": 70
        }, {
            name: "Магний сернокислый семиводный (MgSO4*7H2O), буйский",
            desc: "https://bhz.ru/catalog/standart-min/sulfat-magniya-marka-b/",
            "Mg": 10.07,
            "S": 13.285,
            "solublity25": 70
        }, {
            name: "Магний азотнокислый шестиводный (Mg(NO3)2*6H2O), Ч, Yara KristaMag",
            "Mg": 9.49,
            "N_NO3": 10.938,
            "solublity25": 70
        }, {
            name: "Магний хлористый шестиводный (MgCl2*6H2O), Ч",
            desc: "",
            "Mg": 11.83,
            "Cl": 34.53,
            "solublity25": 100
        },

        {
            name: "Аммоний азотнокислый (NH4NO3), Ч",
            "N_NO3": 17.499,
            "N_NH4": 17.499,
        }, {
            name: "Аммоний сернокислый ((NH4)2SO4, буйский)",
            "N_NH4": 21,
            "S": 24
        },
        /*{
        	"name": "ADOB® Универсал Микро Комплекс", desc: "Железо (Fe) – 4% хелат EDTA, Марганец (Mn) – 3% хелат EDTA, Цинк (Zn) – 3% хелат EDTA, Медь (Cu) – 2% хелат EDTA, Бор (B) – 0.6%, Молибден (Mo) – 0.1%",
        	"Fe": 4, "Zn": 3, "Cu": 2, "Mn": 3, "Mo": 0.1, "B": 0.6, "solublity25": 100
        },*/
        {
            "name": "ADOB® Гидропоник Микро Комплекс",
            desc: "https://pr-agro.ru/catalog/adob-gidroponik-mikro-kompleks/",
            "Fe": 6,
            "Zn": 1.7,
            "Cu": 0.25,
            "Mn": 2.8,
            "Mo": 0.25,
            "B": 1.6,
            "solublity25": 100
        }, {
            "name": "Рексолин APN (Yara)",
            desc: "",
            "Fe": 6,
            "Zn": 1.3,
            "Cu": 0.25,
            "Mn": 2.4,
            "Mo": 0.25,
            "B": 0.85,
            "solublity25": 100
        }, {
            name: "Аквамикс СТ",
            desc: "https://www.bhz.ru/catalog/mikroelementy/akvamiks-st/",
            "Fe": 3.84,
            "Zn": 0.53,
            "Cu": 0.53,
            "Mn": 2.57,
            "Mo": 0.13,
            "B": 0.52,
            "Ca": 2.57,
            "Mo": 0.13
        }, {
            name: "Хелат железа DTPA (FeDTPA), Fe 11%",
            desc: "https://bhzshop.ru/catalog/mikroelementy-garden/khelat-zheleza/",
            "Fe": 11,
            solublity25: 20
        }, {
            name: "Хелат цинка ЭДТА (ZnEDTA), Zn 15%",
            desc: "https://bhzshop.ru/catalog/mikroelementy-garden/khelat-tsinka/",
            "Zn": 15,
            solublity25: 45
        }, {
            "name": "Rexolin Ca (CaEDTA), Ca 9.7%, Yara",
            desc: "https://www.yara.ru/crop-nutrition/products/yaratera/yaratera-rexolin-ca10/",
            "Ca": 9.7
        }, {
            "name": "Калий гидроксид, ч",
            desc: "",
            "K": 69.687,
            "solublity25": 100
        }, {
            "name": "Кислота ортофосфорная, ч (100%, 1.88г/мл) [г]",
            desc: "",
            "P": 31.607,
            "solublity25": 100
        }, {
            "name": "Кислота азотная, конц (68%, 1.4г/мл) [г]",
            desc: "",
            "N_NO3": 15.11,
            "solublity25": 100
        }, {
            "name": "Кислота серная, электролит (37%, 1.27..1.28г/мл) [г]",
            desc: "",
            "S": 12.08,
            "solublity25": 100
        }, {
            "name": "Кислота борная, ч (H3BO3)",
            desc: "",
            "B": 17.484,
            "solublity25": 100
        }, {
            "name": "YaraVita Agriphos (1.48г/мл) [г]",
            desc: "https://www.yara.ru/crop-nutrition/products/yaravita/yaravita-agriphos/",
            "P": 18.766,
            "K": 7.886,
            "Cu": 1.5,
            "Fe": 0.5,
            "Mn": 2,
            "Zn": 1.4,
            "solublity25": 100
        },
        //{ name: "GHE Flora Nova Grow", desc: "*производитель не гарантирует точность состава на этикетке", "N_NH4": 0.9, "N_NO3": 6.1, "P": 1.748, "K": 8.3, "Ca": 2.86, "Mg": 0.904, "Fe": 0.1, "S": 2 },
        //{ name: "GHE Flora Nova Bloom", desc: "*производитель не гарантирует точность состава на этикетке", "N_NH4": 0.5, "N_NO3": 3.75, "P": 3.492, "K": 6.64, "Ca": 2.86, "Mg": 1.206, "Fe": 0.012, "S": 2 },
        //{ name: "GHE Flora Bloom", desc: "*производитель не гарантирует точность состава на этикетке", "P": 2.185, "K": 3.32, "Mg": 3, "S": 2 },
        //{ name: "GHE Flora Micro hardwater", desc: "*производитель не гарантирует точность состава на этикетке", "N_NH4": 1.5, "N_NO3": 3.5, "K": 1.08, "B": 0.01, "Ca": 1, "Cu": 0.01, "Fe": 0.0204, "Mn": 0.04, "Mo": 0.004, "Zn": 0.015 },
        //{ name: "GHE Flora Micro softwater", desc: "*производитель не гарантирует точность состава на этикетке", "N_NH4": 1.5, "N_NO3": 3.5, "K": 1.08, "B": 0.01, "Ca": 5, "Cu": 0.01, "Fe": 0.0204, "Mn": 0.04, "Mo": 0.004, "Zn": 0.015 },
        //{ name: "GHE Flora Gro", desc: "*производитель не гарантирует точность состава на этикетке", "N_NH4": 1, "N_NO3": 2, "P": 0.437, "K": 4.98, "Mg": 0.8 },


    ];


    var atomic_weights = {
        "H": 1,
        "K": 39.1,
        "N": 14,
        "N_NO3": 14,
        "N_NH4": 14,
        "O": 16,
        "Ca": 40.078,
        "Fe": 56,
        "P": 30.974,
        "Mg": 24.305,
        "S": 32,
        "Zn": 65.39,
        "Mo": 95.94,
        "Cu": 3.546,
        "B": 10.811,
        "Mn": 54.938,
        "Cl": 35.453
    };
    // заменить на элементс, добавить валентность к каждому элементу

    var ions = {
        "S": -2,
        "P": -3,
        "SO3": -2,
        "N_NO3": -1,
        "N_NH4": 1,
        "K": 1,
        "Mg": 2,
        "Ca": 2,
        "Cl": -1
    };
    // "Mn": 2, "Cu": 2, "Zn": 2,




    // акварин - 10г, КС - 10г, СМ - 3г 


    var selectedFertilizersModel = [];
    var umolUnits = false;
    var calcResult = {
        elements: [],
        elementsM: [],
        scaledElements: [],
        scaledElementsM: [],
        nitrogenRelatives: 0,
        ec: 0,
        ph: 0
    };
    var scale = 1.0;


    function init() {




        document.getElementById("umolUnitsController").checked = false;
        var fertilizersView = document.getElementById("fertilizersView");
        fertilizersView.innerHTML = "";
        selectedFertilizersModel = [];
        fertilizers.forEach(function(item, index) {
            selectedFertilizersModel[index] = {
                selected: false,
                concentration: 0
            };
            if (fertilizers[index]["N"] == 0 || fertilizers[index]["N"] == null) {
                fertilizers[index]["N"] = 0;
                if (fertilizers[index]["N_NO3"] != null)
                    fertilizers[index]["N"] += fertilizers[index]["N_NO3"];
                if (fertilizers[index]["N_NH4"] != null)
                    fertilizers[index]["N"] += fertilizers[index]["N_NH4"];
            } else {
                if (fertilizers[index]["N"] != fertilizers[index]["N_NO3"] + fertilizers[index]["N_NH4"]) alert("Fertilizer " + fertilizers[index][name] + " nitrogen error!")
            }

            //fertilizersView.innerHTML += "<input type=checkbox id=" + "fertilizersView[" + index + "]" + "> " + item["name"] + "<br>";

            if (item["desc"] == undefined) item["desc"] = "";
            if (item["name"] != null) {
                hrf = "<small><i> " + item["desc"] + " </i></small> "
            } else {
                hrf = "X"
            };
            fertilizersView.innerHTML += "<input type=checkbox id=" + "fertilizersView[" + index + "]" + "> " + item["name"] + hrf + " <br>";



        });

        tableHeadUpdate();

        var tElementsAmount = "<td>Концентрация элементов в растворе</td><td>сумма</td>";
        elements.forEach(function(item, index) {
            tElementsAmount += "<td>" + "0" + "</td>";
        });
        tElementsAmount = "<tr>" + tElementsAmount + "</tr>";
        var elementsAmountView = document.getElementById("elementsAmountView");
        elementsAmountView.innerHTML = tElementsAmount;
        document.getElementById("solutionScale").value = 1.0;

        var parameters = getJsonFromUrl();
        try {
            var state = parameters["st"];
            var recepiet = parameters["rcpt"];
            if (state) {
                setCalcState(state);
                hideFullFertilizersList();
            }
            if (recepiet) {
                setActiveRecepiet(recepiet);
                hideFullFertilizersList();
            }
            updateRecepietLink();
        } catch {
            console.log('something wrong');
        }
    }


    function solve(s) {
        return eval(s.replace(/[^0-9\(\)\+\-\*\/\.]/g, ""));
    }


    function selectedFertilizersModelUpdate() {
        fertilizers.forEach(function(item, index) {
            var ch = document.getElementById("fertilizersView[" + index + "]");
            selectedFertilizersModel[index].selected = ch.checked;
            var concentrationInput = document.getElementById(`concentrationInput${index}`);
            if (document.getElementById(`concentrationInput${index}`) != null) {
                selectedFertilizersModel[index].concentration = solve(concentrationInput.value); // parseFloat(concentrationInput.value); //CalcMolarWeight
            } else {
                selectedFertilizersModel[index].concentration = 0;
            }
        });


        selectedFertilizersModel.forEach(function(item, index) {
            selectedFertilizersModel[index].elements = [];
            selectedFertilizersModel[index].elementsM = [];
            if (item.selected == true) {
                var weight = item.concentration;
                elements.forEach(function(eitem) {
                    var conc = fertilizers[index][eitem];
                    if (conc == null) {
                        conc = 0;
                    }
                    var eWeight = conc / 100.0 * weight;
                    selectedFertilizersModel[index].elements[eitem] = eWeight;
                    selectedFertilizersModel[index].elementsM[eitem] = eWeight / atomic_weights[eitem];
                });

            }
        });
    }

    function selectedFertilizersViewUpdate() {
        selectedFertilizersModel.forEach(function(item, index) {
            var row = document.getElementById("selectedFertilizersViewItem" + index);
            if (item.selected == false && row != null) {
                row.hidden = true;
            } else if (item.selected == true) {
                if (row != null) {
                    row.hidden = false;
                    var trow = `<td>${fertilizers[index].name}</td><td><input type='edit' id='concentrationInput${index}' value='${item.concentration}'></td>`;
                    elements.forEach(function(eitem) {
                        var val = (umolUnits == false) ? +item.elements[eitem].toFixed(4) : +item.elementsM[eitem].toFixed(4);
                        trow += "<td>" + val + "</td>";
                    });
                    row.innerHTML = trow;

                } else {
                    var selectedFertilizersView = document.getElementById("selectedFertilizersView");
                    var trow = `<td>${fertilizers[index].name}</td><td><input type='edit' id='concentrationInput${index}' value='0'></td>`;
                    elements.forEach(function(eitem) {
                        trow += "<td>" + 0 + "</td>";
                    });
                    selectedFertilizersView.innerHTML += `<tr id="selectedFertilizersViewItem${index}">${trow}</tr>`;
                }
            }
        });
        updateRecepietLink();
    }

    function tableHeadUpdate() {
        var thead = "<td>Удобрения</td><td>Концентрация, мг/л</td>";
        elements.forEach(function(item, index) {
            var text = item;
            if (ions[item] >= 1) {
                text = "<font color='red'>" + text + "</font>";
            } else if (ions[item] <= -1) {
                text = "<font color='blue'>" + text + "</font>";
            }
            thead += (umolUnits == false) ? "<td>" + text + ", мг/л</td>" : "<td>" + text + ", ммоль/л</td>";
        });
        var selectedFertilizersViewHead = document.getElementById("selectedFertilizersViewHead");
        selectedFertilizersViewHead.innerHTML = thead;
    }

    function umolUnitsChanged() {
        var ch = document.getElementById("umolUnitsController");
        umolUnits = ch.checked;
        tableHeadUpdate();
        selectedFertilizersModelUpdate();
        selectedFertilizersViewUpdate();
        calculate();
        UpdateCalcResultsView();
        updateRecepietLink();
    }


    function selectedFertilizersControllerEvent() {
        selectedFertilizersModelUpdate();
        selectedFertilizersViewUpdate();
        calculate();
        UpdateCalcResultsView();
        updateRecepietLink();
    }

    function isNotPresent(val) {
        return val === null || val === undefined ? true : false;
    }

    function calculate() {
        calcResult.elements = [];
        calcResult.elementsM = [];
        calcResult.scaledElements = [];
        calcResult.scaledElementsM = [];


        selectedFertilizersModel.forEach(function(item, index) {
            if (item.selected == true) {
                elements.forEach(function(eitem) {
                    if (calcResult.elements[eitem] == null)
                        calcResult.elements[eitem] = 0;

                    if (calcResult.elementsM[eitem] == null)
                        calcResult.elementsM[eitem] = 0;
                    calcResult.elements[eitem] += item.elements[eitem];
                    calcResult.elementsM[eitem] += item.elementsM[eitem];
                    calcResult.scaledElements[eitem] = calcResult.elements[eitem] * scale;
                    calcResult.scaledElementsM[eitem] = calcResult.elementsM[eitem] * scale;
                });
            }
        });

        var elem_full = elements.concat(["Na"]);
        //console.log(elem_full);
        elem_full.forEach(function(item, index) {
            if (isNotPresent(calcResult.elements[item]))
                calcResult.elements[item] = 0;
            if (isNotPresent(calcResult.elementsM[item]))
                calcResult.elementsM[item] = 0;
            if (isNotPresent(calcResult.scaledElements[item]))
                calcResult.scaledElements[item] = 0;
            if (isNotPresent(calcResult.scaledElementsM[item]))
                calcResult.scaledElementsM[item] = 0;
        });


        calcResult.nitrogenRelatives = calcResult.elements["N_NO3"] / calcResult.elements["N_NH4"];
        calcResult.nitrogenNH4PercentRelatives = 100.0 * calcResult.elements["N_NH4"] / calcResult.elements["N"];
    }

    function UpdateCalcResultsView() {
        //console.log(calcResult);
        // вывод полного соотношения элементов
        var tElementsAmount = "<td>Концентрация элементов в растворе</td><td>сумма</td>";
        elements.forEach(function(item, index) {
            tElementsAmount += (umolUnits == false) ? "<td>" + +calcResult.elements[item].toFixed(4) + "</td>" : "<td>" + +calcResult.elementsM[item].toFixed(4) + "</td>";
        });
        tElementsAmount += "</tr><tr>";
        tElementsAmount += "<td></td><td>с учетом множителя</td>";
        elements.forEach(function(item, index) {
            tElementsAmount += (umolUnits == false) ? "<td>" + +calcResult.scaledElements[item].toFixed(4) + "</td>" : "<td>" + +calcResult.scaledElementsM[item].toFixed(4) + "</td>";
        });
        tElementsAmount = "<tr>" + tElementsAmount + "</tr>";
        var elementsAmountView = document.getElementById("elementsAmountView");
        elementsAmountView.innerHTML = tElementsAmount;

        var nitrogenRelativesView = document.getElementById("nitrogenRelativesView");
        nitrogenRelativesView.innerHTML = `N(NH4+):N(NO3-)=1:${+calcResult.nitrogenRelatives.toFixed(1)}=${+((1/calcResult.nitrogenRelatives)).toFixed(3)}, N(NH4+):N(sum)=${+calcResult.nitrogenNH4PercentRelatives.toFixed(2)}%`;


        var n = (umolUnits == false) ? calcResult.elements["N"] : calcResult.elementsM["N"];
        var p = (umolUnits == false) ? calcResult.elements["P"] : calcResult.elementsM["P"];
        var k = (umolUnits == false) ? calcResult.elements["K"] : calcResult.elementsM["K"];
        var ca = (umolUnits == false) ? calcResult.elements["Ca"] : calcResult.elementsM["Ca"];
        var mg = (umolUnits == false) ? calcResult.elements["Mg"] : calcResult.elementsM["Mg"];
        var s = (umolUnits == false) ? calcResult.elements["S"] : calcResult.elementsM["S"];


        var ProfileRelativesView3 = document.getElementById("ProfileRelativesView3");
        ProfileRelativesView3.innerHTML = `N:P:K:Ca:Mg:S = 1 : ${+(p/n).toFixed(2)} : ${+(k/n).toFixed(2)} : ${+(ca/n).toFixed(2)} : ${+(mg/n).toFixed(2)} : ${+(s/n).toFixed(2)}`;


        var norma1 = (p <= n && p <= k) ? p : (n <= k && n <= p) ? n : k;
        var norma2 = (mg <= k && mg <= ca) ? mg : (ca <= k && ca <= mg) ? ca : k;
        var ProfileRelativesView2 = document.getElementById("ProfileRelativesView2");
        ProfileRelativesView2.innerHTML = `N:P:K = ${+(n/norma1).toFixed(2)} : ${+(p/norma1).toFixed(2)} : ${+(k/norma1).toFixed(2)}, K:Ca:Mg = ${+(k/norma2).toFixed(2)} : ${+(ca/norma2).toFixed(2)} : ${+(mg/norma2).toFixed(2)}`;



        var HPGView = document.getElementById("HPGView");
        HPGView.innerHTML = `N=${+calcResult.scaledElements["N"].toFixed(1)} NO3=${+calcResult.scaledElements["N_NO3"].toFixed(2)} NH4=${+calcResult.scaledElements["N_NH4"].toFixed(2)} P=${+calcResult.scaledElements["P"].toFixed(2)} K=${+calcResult.scaledElements["K"].toFixed(2)} Ca=${+calcResult.scaledElements["Ca"].toFixed(2)} Mg=${+calcResult.scaledElements["Mg"].toFixed(2)} S=${+calcResult.scaledElements["S"].toFixed(2)} Cl=${+calcResult.scaledElements["Cl"].toFixed(2)} Fe=${+calcResult.scaledElements["Fe"].toFixed(2)} Mn=${+calcResult.scaledElements["Mn"].toFixed(2)} B=${+calcResult.scaledElements["B"].toFixed(2)} Zn=${+calcResult.scaledElements["Zn"].toFixed(3)} Cu=${+calcResult.scaledElements["Cu"].toFixed(3)} Mo=${+calcResult.scaledElements["Mo"].toFixed(3)} Co=0 Si=0`;

        var ProfileRelativesView1 = document.getElementById("ProfileRelativesView1");
        ProfileRelativesView1.innerHTML = `N:K=${+(n/k).toFixed(2)}, K:Ca=${+(k/ca).toFixed(2)}, K:Mg=${+(k/mg).toFixed(2)}, P=${+(p*scale).toFixed(1)}`;




        var ec = 0.095 * (calcResult.scaledElements["N_NH4"] / 14.0067 + 2 * calcResult.scaledElements["Ca"] / 40.078 + 2 * calcResult.scaledElements["Mg"] / 24.305 + calcResult.scaledElements["K"] / 39.0983 + calcResult.scaledElements["Na"] / 22.9898) + 0.19;
        var ecView = document.getElementById("ecView");
        ecView.innerHTML = +ec.toFixed(3);

        feedingsCalculateAndUpdateView();
        updateRecepietLink();
    }


    function scaleChanged() {
        scale = document.getElementById("solutionScale").value;
        //console.log(scale);
        calculate();
        UpdateCalcResultsView();
        updateRecepietLink();
    }


    function updateSolutionByScale() {
        fertilizers.forEach(function(item, index) {
            if (selectedFertilizersModel[index].concentration != null) {
                selectedFertilizersModel[index].concentration = (scale * selectedFertilizersModel[index].concentration); //.toFixed(3);
            }
        });
        scale = 1.0;
        document.getElementById("solutionScale").value = scale;
        selectedFertilizersViewUpdate();
        selectedFertilizersModelUpdate();
        selectedFertilizersViewUpdate();
        calculate();
        UpdateCalcResultsView();
    }





    function feedingsCalculateAndUpdateView() {
        var solutionVol = document.getElementById("solutionVolume").value;
        var feedingPower = document.getElementById("feedingPower").value;
        var resVol = solutionVol / (feedingPower * 2);
        document.getElementById("feedingVolume").innerHTML = `${+resVol.toFixed(1)}л + ${+resVol.toFixed(1)}л`;
        var res = '<tr><td colspan="2"><b>Рецепт</b></td></tr>';

        selectedFertilizersModel.forEach(function(item, index) {
            if (item.selected == true && item.concentration != 0) {
                res += `<tr><td>${fertilizers[index].name}, г</td><td>${+(item.concentration*solutionVol/1000).toFixed(1)}</td></tr>`;
            }
        });
        document.getElementById("feedingResult").innerHTML = res;
        updateRecepietLink();
    }

    function getJsonFromUrl(url) {
        if (!url) url = location.search;
        var query = url.substr(1);
        var result = {};
        query.split("&").forEach(function(part) {
            var item = part.split("=");
            result[item[0]] = decodeURIComponent(item[1]);
        });
        return result;
    }

    function getCalcStateCode() {
        var state = {};
        state['umol'] = umolUnits;
        state['volume'] = document.getElementById("solutionVolume").value;
        state['feed_pwr'] = document.getElementById("feedingPower").value;
        state['sf'] = getActiveFertilizersCode();
        var res = JSON.stringify(state);
        return res;
    }

    function setCalcState(code) {
        var state = {};
        state = JSON.parse(code);
        if (state['volume'] != undefined)
            document.getElementById("solutionVolume").value = state['volume'];
        if (state['feed_pwr'] != undefined)
            document.getElementById("feedingPower").value = state['feed_pwr'];
        if (state['umol'] != undefined && state['umol'] != umolUnits) {
            document.getElementById("umolUnitsController").checked = state['umol'];
            umolUnitsChanged();
        }
        if (state["sf"] != undefined)
            setActiveFertilizersByCode(state["sf"]);
    }



    function getActiveFertilizersCode() {
        var selectedFertilizersIndexes = [];
        selectedFertilizersModel.forEach(function(item, index) {
            if (selectedFertilizersModel[index].selected == true) {
                selectedFertilizersIndexes.push(index);
            }
        });
        var res = JSON.stringify(selectedFertilizersIndexes);
        return res;
    }

    function setActiveFertilizersByCode(code) {
        var selectedFertilizersIndexes = [];
        selectedFertilizersIndexes = JSON.parse(code);
        selectedFertilizersIndexes.forEach(function(item, index) {
            document.getElementById("fertilizersView[" + item + "]").checked = true;
        });
        selectedFertilizersModelUpdate();
        selectedFertilizersViewUpdate();
    }

    function getActiveRecepiet() {
        var recepiet = {};
        recepiet['scale'] = scale;
        selectedFertilizersModel.forEach(function(item, index) {
            if (selectedFertilizersModel[index].selected == true && selectedFertilizersModel[index].concentration != 0) {
                recepiet[index] = selectedFertilizersModel[index].concentration;
            }
        });
        var res = JSON.stringify(recepiet);
        return res;
    }

    function setActiveRecepiet(code) {
        var recepiet = {};
        recepiet = JSON.parse(code);
        if (recepiet['scale'] != undefined) {
            document.getElementById("solutionScale").value = recepiet['scale'];
            scaleChanged();
        }

        for (var key in recepiet) {
            var checkbox = document.getElementById("fertilizersView[" + key + "]");
            if (checkbox !== null && checkbox !== undefined) {
                checkbox.checked = true;
            }
        }
        selectedFertilizersModelUpdate();
        selectedFertilizersViewUpdate();
        for (var key in recepiet) {
            var input = document.getElementById(`concentrationInput${key}`);
            if (input !== null && input !== undefined) {
                input.value = recepiet[key];
            }
        }
        selectedFertilizersControllerEvent();
    }


    function showFullFertilizersList() {
        document.getElementById("btnShowFullFertilizersList").style.display = "none";
        document.getElementById("btnHideFullFertilizersList").style.display = "";
        document.getElementById("fertilizersView").style.display = "";
    }

    function hideFullFertilizersList() {
        document.getElementById("btnHideFullFertilizersList").style.display = "none";
        document.getElementById("btnShowFullFertilizersList").style.display = "";
        document.getElementById("fertilizersView").style.display = "none";
    }

    function updateRecepietLink() {
        var fullstate = window.location.href.split('?')[0] + '?st=' + getCalcStateCode() + '&rcpt=' + getActiveRecepiet();
        var recepiet = window.location.href.split('?')[0] + '?rcpt=' + getActiveRecepiet();
        document.getElementById("linkRecepiet").innerHTML = document.getElementById("ProfileRelativesView1").innerHTML + ' - ' + recepiet;
        document.getElementById("linkRecepiet").href = recepiet;
        document.getElementById("linkFullState").innerHTML = document.getElementById("ProfileRelativesView1").innerHTML + ' - ' + fullstate;
        document.getElementById("linkFullState").href = fullstate;
        //window.location.href = window.location.href.split('?')[0] + '?sf=' + getActiveFertilizersCode() + '&rcpt=' + getActiveRecepiet();
    }
</script>

<body onload="init()">


    <p><b>Выбор компонентов раствора</b> (удобрения с амидным азотом не добавляются по причине его минимального усвоения корнями)
    </p>
    <p><button onclick="showFullFertilizersList()" id="btnShowFullFertilizersList" style="display: none;">выбрать удобрения</button></p>
    <form onchange="selectedFertilizersControllerEvent()">
        <p id=fertilizersView>
        </p>
    </form>
    <p><button onclick="hideFullFertilizersList()" id="btnHideFullFertilizersList">скрыть список удобрений</button></p>


    <table style="width:100%">
        <thead>
            <tr id="selectedFertilizersViewHead">
            </tr>
        </thead>
        <tbody id="selectedFertilizersView" onchange="selectedFertilizersControllerEvent()">
        </tbody>
        <tfoot id="elementsAmountView">

        </tfoot>
    </table>
    <br>
    <table style="width:40%">
        <thead>
            <tr>
                <td>Подгонка ЕС (множитель)</td>
                <td>Коррекция рецепта</td>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><input type='number' step="0.01" id='solutionScale' onchange="scaleChanged()"></td>
                <td><button onclick="updateSolutionByScale()">произвести!</button></td>
            </tr>
        </tbody>
    </table>
    <br>
    <table style="width:40%">
        <thead>
            <tr>
                <td><b>Результат</b></td>
                <td>Значение</td>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Соотношения [1]</td>
                <td id="ProfileRelativesView1">N:K=?, K:Ca=?, K:Mg=?, P=?</td>
            </tr>
            <tr>
                <td>Соотношения [2]</td>
                <td id="ProfileRelativesView2">N:P:K=?:?:?, K:Ca:Mg=?:?:?</td>
            </tr>

            <tr>
                <td>Соотношения [3]</td>
                <td id="ProfileRelativesView3">N:P:K:Ca:Mg:S=1:?:?:?:?:?</td>
            </tr>

            <tr>
                <td>Формы азота</td>
                <td id="nitrogenRelativesView">N(NH4+):N(NO3-)=?=?%, N(NH4+):N(sum)=?</td>
            </tr>

            <tr>
                <td>EC рассчетный, мСм/см</td>
                <td id="ecView">0</td>
            </tr>

            <tr>
                <td>Для вставки в <a href="https://github.com/siv237/HPG/wiki">HPG</a></td>
                <td id="HPGView">N=0 NO3=0 NH4=0 P=0 K=0 Ca=0 Mg=0 S=0 Cl=0 Fe=0 Mn=0 B=0 Zn=0 Cu=0 Mo=0 Co=0 Si=0 </td>
            </tr>

        </tbody>

    </table>

    <br>
    <table style="width:40%">
        <thead>
            <tr>
                <td colspan="2"><b>Расчет концентратов</b> <i>(бак А - кальций, аммоний и (часть) калий азотнокислые, бак Б - остальное)</i></td>
            </tr>
        </thead>
        <tfoot id="feedingResult"></tfoot>
        <tbody>
            <tr>
                <td>Объем раствора, л</td>
                <td><input type='number' step="1" min="1" value="500" id='solutionVolume' onchange="feedingsCalculateAndUpdateView()"></td>
            </tr>

            <tr>
                <td>Степень концентрированности, 1 к:</td>
                <td><input type='number' step="1" min="1" max="1000" id='feedingPower' value="250" onchange="feedingsCalculateAndUpdateView()"></td>
            </tr>
            <tr>
                <td>Объемы концентратов А, Б:</td>
                <td id="feedingVolume">???</td>
            </tr>

        </tbody>
    </table>

    <form>
        <input type=checkbox id="umolUnitsController" onchange="umolUnitsChanged()" checked="false">ммоль/л вместо мг/л
        <br>



        <p style="visibility: hidden;"><b>EC, мкСм/см:</b></p>
        <p id=ecView>
        </p>
    </form>
    <form>
        <p>Ссылка на рецепт:
            <a href='' id='linkRecepiet'></a>
        </p>

        <p>Ссылка на полное состояние окна:
            <a href='' id='linkFullState'></a>
        </p>
    </form>

    writed by Egor Tryakshin, 2019-2021 <br> tg: @zeromind, inst:<a href="https://instagram.com/meveric.iot">meveric.iot</a><br> Создано при поддержке <a href="https://otree.ru/">OrangeTree</a>, <a href="https://t.me/ponics_ru">@ponics_ru</a>, <a href="https://t-do.ru/joinchat/Ef_eu0bCIkePVJ4-LOLRGQ">
        #Klubnika_project</a><br>Выразить благодарность автору: <br>[BTC] bc1qzghuflzew8ynl5t55utjsklhd03r4vzm23rep0 <br> [Банковкой картой]<a href="https://yoomoney.ru/to/4100116887691160"> перевод через юмани</a>
</body>

</html>